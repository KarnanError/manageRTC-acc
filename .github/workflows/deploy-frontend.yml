name: Deploy Frontend

# This workflow is identical in both repos.
# Environment is determined entirely by the GitHub secrets configured in each repo:
#   KarnanError/manageRTC-acc  → set ACC secrets → deploys to acceptance.manage-rtc.com
#   Sudhakarnan/manageRTC      → set DEV secrets → deploys to dev.manage-rtc.com

on:
  push:
    branches: [ main ]
    paths:
      - "react/**"
      - ".github/workflows/deploy-frontend.yml"
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: react

    env:
      FRONTEND_DEPLOY_PATH: ${{ secrets.FRONTEND_DEPLOY_PATH }}
      FRONTEND_STAGING_DIR: ${{ secrets.FRONTEND_STAGING_DIR }}
      BACKEND_API_URL:      ${{ secrets.BACKEND_API_URL }}
      FRONTEND_URL:         ${{ secrets.FRONTEND_URL }}
      BACKUP_PREFIX_FE:     ${{ secrets.BACKUP_PREFIX_FE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log deployment target
        run: |
          echo "Repo     : ${{ github.repository }}"
          echo "Frontend : ${{ env.FRONTEND_URL }}"
          echo "API      : ${{ env.BACKEND_API_URL }}"

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Write .env.production
        run: |
          printf 'REACT_APP_CLERK_PUBLISHABLE_KEY=%s\nREACT_APP_BACKEND_URL=%s\n' \
            "${{ secrets.CLERK_PUBLISHABLE_KEY_PUBLIC }}" \
            "${{ env.BACKEND_API_URL }}" > .env.production

      - name: Install & build
        env:
          CI: false
        run: |
          npm ci
          npm run build

      - name: Upload build to VPS (temp)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "react/build/**"
          target: "/home/${{ secrets.VPS_USER }}/${{ env.FRONTEND_STAGING_DIR }}/"
          strip_components: 1

      - name: Backup current deployment
        uses: appleboy/ssh-action@v1.0.3
        env:
          DEPLOY_PATH: ${{ env.FRONTEND_DEPLOY_PATH }}
          BACKUP_PREFIX: ${{ env.BACKUP_PREFIX_FE }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          envs: DEPLOY_PATH,BACKUP_PREFIX
          script: |
            set -e
            mkdir -p ~/backups
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            if [ -d "$DEPLOY_PATH" ] && [ "$(ls -A $DEPLOY_PATH 2>/dev/null)" ]; then
              echo "Creating backup: $BACKUP_PREFIX-$TIMESTAMP.tar.gz"
              tar -czf ~/backups/$BACKUP_PREFIX-$TIMESTAMP.tar.gz -C $DEPLOY_PATH .
              ls -t ~/backups/$BACKUP_PREFIX-*.tar.gz 2>/dev/null | tail -n +6 | xargs -r rm -f
              echo "Backup completed."
              ls -la ~/backups/$BACKUP_PREFIX-*.tar.gz 2>/dev/null
            else
              echo "No existing deployment to backup"
            fi

      - name: Activate on VPS
        uses: appleboy/ssh-action@v1.0.3
        env:
          DEPLOY_PATH: ${{ env.FRONTEND_DEPLOY_PATH }}
          STAGING_DIR: ${{ env.FRONTEND_STAGING_DIR }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          envs: DEPLOY_PATH,STAGING_DIR
          script: |
            set -e
            mkdir -p $DEPLOY_PATH
            rm -rf $DEPLOY_PATH/*
            cp -r ~/$STAGING_DIR/build/* $DEPLOY_PATH/
            find $DEPLOY_PATH -type f -name "*.map" -delete
            sudo systemctl reload nginx

      - name: Health check
        uses: appleboy/ssh-action@v1.0.3
        env:
          DEPLOY_PATH: ${{ env.FRONTEND_DEPLOY_PATH }}
          FRONTEND_URL: ${{ env.FRONTEND_URL }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          envs: DEPLOY_PATH,FRONTEND_URL
          script: |
            set -e
            echo "Running frontend health check..."

            if ! systemctl is-active --quiet nginx; then
              echo "ERROR: nginx is not running!"
              sudo systemctl status nginx
              exit 1
            fi

            if [ ! -f "$DEPLOY_PATH/index.html" ]; then
              echo "ERROR: index.html not found at $DEPLOY_PATH"
              ls -la $DEPLOY_PATH/
              exit 1
            fi

            MAX_RETRIES=3
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:80/)
              if echo "$HTTP_CODE" | grep -qE "^(200|301|302|304)$"; then
                echo "Health check passed! Frontend deployed at: $FRONTEND_URL"
                exit 0
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "Attempt $RETRY_COUNT failed (HTTP: $HTTP_CODE), retrying..."
              sleep 3
            done

            echo "WARNING: Health check did not pass after $MAX_RETRIES attempts"
            sudo tail -n 20 /var/log/nginx/error.log
            exit 1
